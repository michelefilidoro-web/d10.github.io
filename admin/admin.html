<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <title>Area Admin — Messaggi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<nav class="navbar navbar-dark bg-dark mb-4">
  <div class="container">
    <span class="navbar-brand">Area Admin</span>
    <ul class="navbar-nav flex-row">
  <li class="nav-item">
    <a class="nav-link active px-3" href="/admin/">Messaggi</a>
  </li>
  <li class="nav-item">
    <a class="nav-link px-3" href="/admin/gestioneutenti">Gestione Utenti</a>
  </li>
</ul>

    <a class="btn btn-sm btn-outline-light" href="/logout.php">Logout</a>
  </div>
</nav>

<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h4 mb-0">Messaggi contatti</h1>
    <span id="totalSpan" class="text-muted small">Totale: —</span>
  </div>

  <form id="searchForm" class="row g-2 mb-3">
    <div class="col-sm-6 col-md-8">
      <input type="text" class="form-control" id="q" placeholder="Cerca in nome, email, oggetto o messaggio…">
    </div>
    <div class="col-sm-3 col-md-2 d-grid">
      <button class="btn btn-dark" type="submit">Cerca</button>
    </div>
    <div class="col-sm-3 col-md-2 d-grid">
      <button id="resetBtn" class="btn btn-outline-secondary" type="button">Reset</button>
    </div>
  </form>

  <div class="card shadow-sm">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0" id="msgTable">
        <thead class="table-light">
          <tr>
            <th>#</th>
            <th>Data</th>
            <th>Nome</th>
            <th>Email</th>
            <th>Oggetto</th>
            <th>Messaggio</th>
            <th class="text-end">Azioni</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="7" class="text-center text-muted py-4">Caricamento…</td></tr>
        </tbody>
      </table>
    </div>
    <div class="card-footer d-flex justify-content-between align-items-center">
      <span id="pageInfo" class="small text-muted"></span>
      <nav><ul class="pagination mb-0" id="pager"></ul></nav>
    </div>
  </div>
</div>

<!-- Modal dettaglio -->
<div class="modal fade" id="viewModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Dettaglio messaggio</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
      </div>
      <div class="modal-body">
        <dl class="row mb-0" id="detailDL"></dl>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
const tableBody = document.querySelector('#msgTable tbody');
const totalSpan = document.getElementById('totalSpan');
const pager = document.getElementById('pager');
const pageInfo = document.getElementById('pageInfo');
const searchForm = document.getElementById('searchForm');
const qInput = document.getElementById('q');
const resetBtn = document.getElementById('resetBtn');

let state = { page: 1, q: '' };

function cut(s, len=80){ if(!s) return ''; s = s.trim(); return s.length<=len ? s : s.slice(0, len-1)+'…'; }
function esc(s){ const div=document.createElement('div'); div.textContent=s??''; return div.innerHTML; }

async function loadData(){
  tableBody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4">Caricamento…</td></tr>';
  try{
    const params = new URLSearchParams({ action:'list', page: state.page, q: state.q });
    const res = await fetch('admin_api.php?' + params.toString(), { headers: { 'Accept':'application/json' }, credentials:'same-origin' });
    if(res.status === 401){ window.location.href = '/login.php?redirect=/admin/'; return; }
    const data = await res.json();
    if(!data.ok) throw new Error(data.error || 'Errore');

    totalSpan.textContent = 'Totale: ' + data.total;
    pageInfo.textContent = `Pagina ${data.page} di ${data.pages}`;

    if(!data.items.length){
      tableBody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4">Nessun messaggio trovato.</td></tr>';
    }else{
      tableBody.innerHTML = data.items.map(r => `
        <tr>
          <td>${r.id}</td>
          <td><span class="text-nowrap">${esc(r.created_at)}</span></td>
          <td>${esc(r.nome)}</td>
          <td><a href="mailto:${esc(r.email)}">${esc(r.email)}</a></td>
          <td>${esc(cut(r.oggetto))}</td>
          <td>${esc(cut(r.messaggio))}</td>
          <td class="text-end">
            <button class="btn btn-sm btn-outline-primary" data-view="${r.id}">Vedi</button>
          </td>
        </tr>
      `).join('');
    }

    // pager
    pager.innerHTML = '';
    const addItem = (label, p, disabled=false, active=false) => {
      const li = document.createElement('li');
      li.className = 'page-item' + (disabled?' disabled':'') + (active?' active':'');
      li.innerHTML = `<a class="page-link" href="#">${label}</a>`;
      li.addEventListener('click', (e) => { e.preventDefault(); if(disabled||active) return; state.page = p; loadData(); });
      pager.appendChild(li);
    };
    addItem('«', Math.max(1, data.page-1), data.page<=1, false);
    const start = Math.max(1, data.page-2);
    const end = Math.min(data.pages, data.page+2);
    for(let p=start;p<=end;p++) addItem(String(p), p, false, p===data.page);
    addItem('»', Math.min(data.pages, data.page+1), data.page>=data.pages, false);

  }catch(err){
    tableBody.innerHTML = `<tr><td colspan="7" class="text-center text-danger py-4">Errore: ${esc(err.message)}</td></tr>`;
  }
}

searchForm.addEventListener('submit', (e)=>{
  e.preventDefault();
  state.q = qInput.value.trim();
  state.page = 1;
  loadData();
});
resetBtn.addEventListener('click', ()=>{
  qInput.value = '';
  state.q = '';
  state.page = 1;
  loadData();
});

// Dettaglio
document.addEventListener('click', async (e)=>{
  const btn = e.target.closest('[data-view]');
  if(!btn) return;
  const id = btn.getAttribute('data-view');

  try{
    const res = await fetch('admin_api.php?action=view&id='+encodeURIComponent(id), { headers:{'Accept':'application/json'}, credentials:'same-origin' });
    if(res.status === 401){ window.location.href = '/login.php?redirect=/admin/'; return; }
    const data = await res.json();
    if(!data.ok) throw new Error(data.error || 'Errore');
    const r = data.item;
    const dl = document.getElementById('detailDL');
    dl.innerHTML = `
      <dt class="col-sm-3">ID</dt><dd class="col-sm-9">${r.id}</dd>
      <dt class="col-sm-3">Data</dt><dd class="col-sm-9">${esc(r.created_at)}</dd>
      <dt class="col-sm-3">Nome</dt><dd class="col-sm-9">${esc(r.nome)}</dd>
      <dt class="col-sm-3">Email</dt><dd class="col-sm-9"><a href="mailto:${esc(r.email)}">${esc(r.email)}</a></dd>
      <dt class="col-sm-3">Oggetto</dt><dd class="col-sm-9">${esc(r.oggetto)}</dd>
      <dt class="col-sm-3">Messaggio</dt><dd class="col-sm-9"><pre class="mb-0" style="white-space:pre-wrap">${esc(r.messaggio)}</pre></dd>
      <dt class="col-sm-3">IP</dt><dd class="col-sm-9">${esc(r.ip||'')}</dd>
      <dt class="col-sm-3">User Agent</dt><dd class="col-sm-9">${esc(r.user_agent||'')}</dd>
    `;
    const modal = new bootstrap.Modal(document.getElementById('viewModal'));
    modal.show();
  }catch(err){
    alert('Errore: '+err.message);
  }
});

loadData();
</script>
</body>
</html>
