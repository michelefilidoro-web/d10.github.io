<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <title>Area Admin — Gestione Utenti</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<nav class="navbar navbar-dark bg-dark mb-4">
  <div class="container d-flex justify-content-between align-items-center">
    <span class="navbar-brand">Area Admin</span>
    <ul class="navbar-nav flex-row">
    <li class="nav-item">
        <a class="nav-link px-3" href="/admin/">Messaggi</a>
    </li>
    <li class="nav-item">
        <a class="nav-link active px-3" href="/admin/gestioneutenti">Gestione Utenti</a>
    </li>
    <li class="nav-item">
      <a class="nav-link px-3" href="/admin/tickets">Gestione tickets</a>
    </li>
    </ul>

    <a class="btn btn-sm btn-outline-light" href="/logout.php">Logout</a>
  </div>
</nav>

<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h4 mb-0">Gestione utenti</h1>
    <span id="totalSpan" class="text-muted small">Totale: —</span>
  </div>

  <form id="searchForm" class="row g-2 mb-3">
    <div class="col-sm-6 col-md-8">
      <input type="text" class="form-control" id="q" placeholder="Cerca in nome utente o email…">
    </div>
    <div class="col-sm-3 col-md-2 d-grid">
      <button class="btn btn-dark" type="submit">Cerca</button>
    </div>
    <div class="col-sm-3 col-md-2 d-grid">
      <button id="resetBtn" class="btn btn-outline-secondary" type="button">Reset</button>
    </div>
  </form>

  <div class="card shadow-sm">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0" id="usersTable">
        <thead class="table-light">
          <tr>
            <th>#</th>
            <th>Nome utente</th>
            <th>Email</th>
            <th>Ruolo</th>
            <th class="text-end">Azioni</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="5" class="text-center text-muted py-4">Caricamento…</td></tr>
        </tbody>
      </table>
    </div>
    <div class="card-footer d-flex flex-wrap gap-2 justify-content-between align-items-center">
      <div class="d-flex align-items-center gap-2">
        <button id="saveAllBtn" class="btn btn-success btn-sm" type="button" disabled>Salva modifiche</button>
        <button id="discardAllBtn" class="btn btn-outline-secondary btn-sm" type="button" disabled>Annulla</button>
        <span id="dirtyBadge" class="badge text-bg-warning d-none">0 modifiche</span>
      </div>
      <div class="d-flex align-items-center gap-2">
        <span id="pageInfo" class="small text-muted"></span>
        <nav><ul class="pagination mb-0" id="pager"></ul></nav>
      </div>
    </div>
  </div>
</div>

<!-- Toast container -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index:1080">
  <div id="toastStack"></div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ==== Helper UI ====
function esc(s){ const d=document.createElement('div'); d.textContent=s??''; return d.innerHTML; }
function showToast(message, variant='primary'){
  const div = document.createElement('div');
  div.className = `toast align-items-center text-bg-${variant} border-0`;
  div.role = 'alert'; div.ariaLive='assertive'; div.ariaAtomic='true';
  div.innerHTML = `<div class="d-flex"><div class="toast-body">${esc(message)}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>`;
  document.getElementById('toastStack').appendChild(div);
  new bootstrap.Toast(div, { delay: 2500 }).show();
}

// ==== Stato & riferimenti ====
const tableBody = document.querySelector('#usersTable tbody');
const totalSpan = document.getElementById('totalSpan');
const pager = document.getElementById('pager');
const pageInfo = document.getElementById('pageInfo');
const searchForm = document.getElementById('searchForm');
const qInput = document.getElementById('q');
const resetBtn = document.getElementById('resetBtn');
const saveAllBtn = document.getElementById('saveAllBtn');
const discardAllBtn = document.getElementById('discardAllBtn');
const dirtyBadge = document.getElementById('dirtyBadge');

let state = { page: 1, q: '' };
let dirty = new Map(); // idUtente -> nuovoRuolo

// ==== Ruoli (frontend) ====
const ROLES = [
  { value: 1, label: 'Admin' },
  { value: 2, label: 'Utente' },
  { value: 3, label: 'Avanzato' }
];

function roleSelect(current){
  return `<select class="form-select form-select-sm w-auto" data-role>
    ${ROLES.map(r=>`<option value="${r.value}" ${Number(current)===r.value?'selected':''}>${r.label}</option>`).join('')}
  </select>`;
}

function updateDirtyUI(){
  const count = dirty.size;
  saveAllBtn.disabled = count===0;
  discardAllBtn.disabled = count===0;
  dirtyBadge.textContent = `${count} modifica${count!==1?'he':''}`;
  dirtyBadge.classList.toggle('d-none', count===0);
}

async function loadUsers(){
  tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">Caricamento…</td></tr>';
  try{
    const params = new URLSearchParams({ action:'list_users', page: state.page, q: state.q });
    const res = await fetch('admin_users_api.php?' + params.toString(), { headers: { 'Accept':'application/json' }, credentials:'same-origin' });
    if(res.status === 401){ window.location.href = '/login.php?redirect=/admin/gestioneutenti.html'; return; }
    const data = await res.json();
    if(!data.ok) throw new Error(data.error || 'Errore');

    totalSpan.textContent = 'Totale: ' + data.total;
    pageInfo.textContent = `Pagina ${data.page} di ${data.pages}`;

    if(!data.items.length){
      tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">Nessun utente trovato.</td></tr>';
    } else {
      tableBody.innerHTML = data.items.map(u => `
        <tr data-id="${u.id}">
          <td>${u.id}</td>
          <td>${esc(u.nome_utente ?? '')}</td>
          <td><a href="mailto:${esc(u.email)}">${esc(u.email)}</a></td>
          <td>
            ${roleSelect(u.ruolo)}
          </td>
          <td class="text-end">
            <button class="btn btn-sm btn-primary" data-save>Salva</button>
            <button class="btn btn-sm btn-outline-secondary ms-1" data-reset>Reset</button>
          </td>
        </tr>
      `).join('');
    }

    // pager
    pager.innerHTML='';
    const addItem = (label, p, disabled=false, active=false) => {
      const li = document.createElement('li');
      li.className = 'page-item' + (disabled?' disabled':'') + (active?' active':'');
      li.innerHTML = `<a class="page-link" href="#">${label}</a>`;
      li.addEventListener('click', (e)=>{ e.preventDefault(); if(disabled||active) return; state.page=p; loadUsers(); });
      pager.appendChild(li);
    };
    addItem('«', Math.max(1, data.page-1), data.page<=1, false);
    const start = Math.max(1, data.page-2);
    const end = Math.min(data.pages, data.page+2);
    for(let p=start;p<=end;p++) addItem(String(p), p, false, p===data.page);
    addItem('»', Math.min(data.pages, data.page+1), data.page>=data.pages, false);

  }catch(err){
    tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-danger py-4">Errore: ${esc(err.message)}</td></tr>`;
  }
}

// Cambi ruolo (tracking "dirty")
document.addEventListener('change', (e)=>{
  const sel = e.target.closest('select[data-role]');
  if(!sel) return;
  const tr = sel.closest('tr');
  const id = tr.getAttribute('data-id');
  const newRole = parseInt(sel.value, 10);
  const original = parseInt((tr.getAttribute('data-original-role') || sel.getAttribute('data-original-role') || tr.dataset.originalRole || tr.getAttribute('data-orig') || sel.defaultValue || newRole), 10);
  // Semplice: se diverso dal valore attuale nella riga (salvato in dataset), marca dirty
  const currentCellOriginal = parseInt(tr.dataset.roleOriginal ?? original ?? newRole, 10);
  if(newRole !== currentCellOriginal){ dirty.set(id, newRole); }
  else { dirty.delete(id); }
  updateDirtyUI();
});

// Click su SALVA / RESET riga
document.addEventListener('click', async (e)=>{
  const btnSave = e.target.closest('[data-save]');
  const btnReset = e.target.closest('[data-reset]');
  if(!btnSave && !btnReset) return;
  const tr = e.target.closest('tr');
  const id = tr.getAttribute('data-id');
  const sel = tr.querySelector('select[data-role]');

  if(btnReset){
    // Ripristina valore originale
    const original = parseInt(tr.dataset.roleOriginal ?? sel.defaultValue ?? sel.value, 10);
    sel.value = original;
    dirty.delete(id);
    updateDirtyUI();
    return;
  }

  // SALVA singola riga
  const newRole = parseInt(sel.value, 10);
  await saveRole(id, newRole, tr, sel);
});

async function saveRole(id, roleValue, tr, sel){
  try{
    const res = await fetch('admin_users_api.php', {
      method: 'POST',
      headers: { 'Content-Type':'application/json', 'Accept':'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify({ action:'update_role', id: Number(id), ruolo: Number(roleValue) })
    });
    if(res.status === 401){ window.location.href = '/login.php?redirect=/admin/gestioneutenti.html'; return; }
    const data = await res.json();
    if(!data.ok) throw new Error(data.error || 'Errore salvataggio');

    // fissa originale = nuovo
    sel.defaultValue = String(roleValue);
    tr.dataset.roleOriginal = String(roleValue);
    dirty.delete(String(id));
    updateDirtyUI();
    showToast('Ruolo aggiornato', 'success');
  }catch(err){
    showToast(err.message, 'danger');
  }
}

// Salva tutto
saveAllBtn.addEventListener('click', async ()=>{
  if(dirty.size === 0) return;
  const payload = Array.from(dirty.entries()).map(([id, ruolo]) => ({ id: Number(id), ruolo: Number(ruolo) }));
  try{
    const res = await fetch('admin_users_api.php', {
      method: 'POST',
      headers: { 'Content-Type':'application/json', 'Accept':'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify({ action:'bulk_update_roles', items: payload })
    });
    if(res.status === 401){ window.location.href = '/login.php?redirect=/admin/gestioneutenti.html'; return; }
    const data = await res.json();
    if(!data.ok) throw new Error(data.error || 'Errore salvataggio');

    // Reset stato "dirty" e ricarica
    dirty.clear();
    updateDirtyUI();
    showToast('Modifiche salvate', 'success');
    loadUsers();
  }catch(err){
    showToast(err.message, 'danger');
  }
});

discardAllBtn.addEventListener('click', ()=>{ dirty.clear(); updateDirtyUI(); loadUsers(); });

// Ricerca
searchForm.addEventListener('submit', (e)=>{ e.preventDefault(); state.q=qInput.value.trim(); state.page=1; loadUsers(); });
resetBtn.addEventListener('click', ()=>{ qInput.value=''; state.q=''; state.page=1; loadUsers(); });

// Caricamento iniziale
loadUsers();
</script>
</body>
</html>